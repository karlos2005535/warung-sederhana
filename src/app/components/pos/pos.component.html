<div class="pos-container">
  <div class="pos-header">
    <h2>
      <span class="icon">üí≥</span>
      <div class="title-text">
        POS Kasir
        <span style="font-size: 0.8rem; display: block; color: #64748b; font-weight: 400"
          >Sistem Pembayaran & Refund</span
        >
      </div>
    </h2>
    <div class="header-actions">
      <button class="btn-refund-history" (click)="toggleRefundHistory()">
        <span>üìã</span> Riwayat Refund
      </button>
      <button class="btn-back" (click)="goBack()"><span>‚¨Ö</span> Dashboard</button>
    </div>
  </div>

  <div class="pos-layout">
    <div class="left-panel">
      <div class="products-section">
        <h3>üõçÔ∏è Produk Tersedia</h3>
        <div class="products-grid">
          <div
            *ngFor="let product of products"
            class="product-card"
            [class.out-of-stock]="product.stock === 0"
          >
            <div class="product-info">
              <strong>{{ product.name }}</strong>
              <div class="price">Rp {{ product.price.toLocaleString('id-ID') }}</div>
              <small class="stock">
                <span [style.color]="product.stock < 5 ? '#ef4444' : '#64748b'">
                  Stok: {{ product.stock }}
                </span>
                ‚Ä¢ {{ product.category }}
              </small>
            </div>
            <button (click)="addToCart(product)" [disabled]="product.stock === 0" class="btn-add">
              {{ product.stock === 0 ? 'Habis' : '+ Tambah' }}
            </button>
          </div>
        </div>
      </div>

      <div class="transactions-container">
        <h3>üìã Transaksi Terakhir (Aktif)</h3>

        <div
          *ngIf="recentTransactions.length === 0"
          class="no-transactions"
          style="text-align: center; color: #94a3b8; padding: 20px"
        >
          <p>Belum ada transaksi hari ini.</p>
        </div>

        <div *ngFor="let transaction of recentTransactions" class="transaction-item">
          <div class="transaction-info">
            <div class="transaction-header">
              <strong>#{{ transaction.id }}</strong>
              <span>‚Ä¢ {{ transaction.date | date : 'HH:mm' }}</span>
            </div>
            <div class="transaction-details">
              <p>
                Total: <strong>Rp {{ transaction.total.toLocaleString('id-ID') }}</strong>
              </p>
              <p style="font-size: 0.8rem; color: #64748b">({{ transaction.items.length }} Item)</p>
            </div>
          </div>
          <div class="transaction-actions">
            <button (click)="openCancelModal(transaction)" class="btn-cancel" title="Refund">
              üîÑ Refund
            </button>
            <button
              (click)="removeTransaction(transaction)"
              class="btn-remove-transaction"
              title="Hapus tampilan"
            >
              ‚úï
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="showRefundHistory" class="refund-history-section">
        <h4>üí∏ Log Pengembalian Dana</h4>
        <div style="margin-bottom: 15px; font-weight: bold; color: #4f46e5">
          Total Refund: Rp {{ getRefundTotal().toLocaleString('id-ID') }}
        </div>

        <div *ngFor="let refund of refundHistory" class="transaction-item">
          <div class="transaction-info">
            <strong>ID: {{ refund.id }}</strong>
            <div style="color: #ef4444; font-weight: bold">
              - Rp {{ refund.refundAmount.toLocaleString('id-ID') }}
            </div>
            <small>{{ refund.reason }} ‚Ä¢ {{ refund.refundDate | date : 'dd/MM HH:mm' }}</small>
          </div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="cart-container">
        <h3>
          <span>üõí</span> Keranjang Belanja
          <span *ngIf="cart.length > 0" style="margin-left: auto; font-size: 0.8em; opacity: 0.8"
            >{{ cart.length }} Item</span
          >
        </h3>

        <div class="cart-items-scroll">
          <div *ngIf="cart.length === 0" class="empty-cart">
            <div style="font-size: 3rem; margin-bottom: 10px">üßæ</div>
            <p>Keranjang Kosong</p>
            <small>Pilih produk di sebelah kiri</small>
          </div>

          <div *ngFor="let item of cart" class="cart-item">
            <div class="item-info">
              <strong>{{ item.name }}</strong>
              <p>@ Rp {{ item.price.toLocaleString('id-ID') }}</p>
              <strong class="item-total"
                >Rp {{ (item.price * item.quantity).toLocaleString('id-ID') }}</strong
              >
            </div>
            <div class="item-actions">
              <button (click)="decreaseQuantity(item)" class="btn-quantity">‚àí</button>
              <span class="quantity">{{ item.quantity }}</span>
              <button (click)="increaseQuantity(item)" class="btn-quantity">+</button>
              <button (click)="removeFromCart(item)" class="btn-remove" title="Hapus">üóëÔ∏è</button>
            </div>
          </div>
        </div>

        <div class="payment-section">
          <div class="total-section">
            <label>Total Tagihan</label>
            <div class="total-amount">Rp {{ getTotal().toLocaleString('id-ID') }}</div>
          </div>

          <div class="cash-input" *ngIf="cart.length > 0">
            <label>Uang Tunai Diterima</label>
            <div class="cash-input-container">
              <span class="currency-prefix">Rp</span>
              <input
                type="text"
                [(ngModel)]="cashFormatted"
                (input)="onCashInput($event)"
                (blur)="onCashBlur()"
                (focus)="onCashFocus()"
                placeholder="0"
                class="form-input cash-input-field"
                [class.input-error]="getChange() < 0"
              />
            </div>
          </div>

          <div *ngIf="cash > 0 && cart.length > 0" class="change-section">
            <label>Kembalian</label>
            <div [class]="getChange() < 0 ? 'change-negative' : 'change-positive'">
              Rp {{ getChange().toLocaleString('id-ID') }}
            </div>
          </div>
          <small
            *ngIf="getChange() < 0 && cash > 0"
            style="color: #ef4444; display: block; margin-top: 5px"
            >‚ö†Ô∏è Uang tunai kurang!</small
          >

          <button
            (click)="processPayment()"
            [disabled]="cart.length === 0 || cash < getTotal()"
            class="btn-pay"
          >
            Bayar Sekarang ‚ûî
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showCancelModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Konfirmasi Refund</h3>
        <button (click)="closeCancelModal()" class="btn-close">√ó</button>
      </div>

      <div *ngIf="selectedTransaction" class="cancel-details">
        <div class="detail-grid">
          <div>
            <small style="color: #64748b">ID Transaksi</small>
            <div style="font-weight: bold">{{ selectedTransaction.id }}</div>
          </div>
          <div>
            <small style="color: #64748b">Waktu</small>
            <div style="font-weight: bold">
              {{ selectedTransaction.date | date : 'dd/MM/yy HH:mm' }}
            </div>
          </div>
        </div>

        <div class="refund-section" style="text-align: center; margin: 20px 0">
          <label style="color: #64748b">Total Uang Dikembalikan</label>
          <div style="font-size: 2rem; font-weight: 800; color: #ef4444">
            Rp {{ selectedTransaction.cashReceived.toLocaleString('id-ID') }}
          </div>
          <small style="background: #fee2e2; color: #b91c1c; padding: 4px 8px; border-radius: 4px"
            >Metode: Tunai</small
          >
        </div>

        <div class="cancel-items" style="background: #f8fafc; padding: 15px; border-radius: 8px">
          <h4 style="margin-top: 0; font-size: 0.9rem">Barang kembali ke stok:</h4>
          <div
            *ngFor="let item of selectedTransaction.items"
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 5px;
              font-size: 0.9rem;
            "
          >
            <span>{{ item.quantity }}x {{ item.name }}</span>
            <span>Rp {{ (item.price * item.quantity).toLocaleString('id-ID') }}</span>
          </div>
        </div>

        <div class="warning-message">
          <div class="warning-icon">‚ö†Ô∏è</div>
          <div class="warning-text">
            <strong>Perhatian:</strong> Transaksi akan dibatalkan permanen. Stok akan otomatis
            bertambah kembali.
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button (click)="closeCancelModal()" class="btn-secondary">Batal</button>
        <button (click)="cancelTransaction()" class="btn-danger">Proses Refund</button>
      </div>
    </div>
  </div>
</div>
