<div class="pos-container">
  <div class="pos-header">
    <h2>ğŸ’³ POS Kasir</h2>
    <button class="btn-back" (click)="goBack()">â¬… Kembali</button>
  </div>

  <div class="pos-content">
    <!-- Daftar Produk -->
    <div class="products-section">
      <h3>ğŸ›ï¸ Daftar Produk</h3>
      <div class="products-grid">
        <div
          *ngFor="let product of products"
          class="product-card"
          [class.out-of-stock]="product.stock === 0"
        >
          <div class="product-info">
            <strong>{{ product.name }}</strong>
            <p>Rp {{ product.price.toLocaleString('id-ID') }}</p>
            <small>Stok: {{ product.stock }} | {{ product.category }}</small>
          </div>
          <button (click)="addToCart(product)" [disabled]="product.stock === 0" class="btn-add">
            {{ product.stock === 0 ? 'âŒ Habis' : '+ Tambah' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Keranjang Belanja -->
    <div class="cart-section">
      <h3>ğŸ›’ Keranjang Belanja</h3>

      <div *ngIf="cart.length === 0" class="empty-cart">Keranjang belanja kosong</div>

      <div *ngFor="let item of cart" class="cart-item">
        <div class="item-info">
          <strong>{{ item.name }}</strong>
          <p>Rp {{ item.price.toLocaleString('id-ID') }} x {{ item.quantity }}</p>
          <strong>Total: Rp {{ (item.price * item.quantity).toLocaleString('id-ID') }}</strong>
        </div>
        <div class="item-actions">
          <button (click)="decreaseQuantity(item)" class="btn-quantity">-</button>
          <span class="quantity">{{ item.quantity }}</span>
          <button (click)="increaseQuantity(item)" class="btn-quantity">+</button>
          <button (click)="removeFromCart(item)" class="btn-remove">ğŸ—‘ï¸</button>
        </div>
      </div>

      <!-- Pembayaran -->
      <div *ngIf="cart.length > 0" class="payment-section">
        <h4>ğŸ’µ Pembayaran</h4>

        <div class="total-section">
          <label>Total Belanja:</label>
          <div class="total-amount">Rp {{ getTotal().toLocaleString('id-ID') }}</div>
        </div>

        <div class="cash-input">
          <label>Uang Bayar:</label>
          <input
            type="number"
            [(ngModel)]="cash"
            placeholder="Masukkan jumlah uang"
            class="form-input"
          />
        </div>

        <div *ngIf="cash > 0" class="change-section">
          <label>Kembalian:</label>
          <div [class]="getChange() < 0 ? 'change-negative' : 'change-positive'">
            Rp {{ getChange().toLocaleString('id-ID') }}
            <span *ngIf="getChange() < 0" class="warning">(Uang kurang!)</span>
          </div>
        </div>

        <button (click)="processPayment()" [disabled]="cash < getTotal()" class="btn-pay">
          ğŸ’° Proses Pembayaran
        </button>
      </div>

      <!-- Transaksi Terakhir -->
      <div *ngIf="recentTransactions.length > 0" class="recent-transactions">
        <h4>ğŸ“‹ Transaksi Terakhir</h4>
        <div *ngFor="let transaction of recentTransactions" class="transaction-item">
          <div class="transaction-info">
            <strong>ID: {{ transaction.id }}</strong>
            <p>{{ transaction.date | date : 'dd/MM/yyyy HH:mm' }}</p>
            <p>Total: Rp {{ transaction.total.toLocaleString('id-ID') }}</p>
            <p>Bayar: Rp {{ transaction.cashReceived.toLocaleString('id-ID') }}</p>
          </div>
          <button
            (click)="openCancelModal(transaction)"
            class="btn-cancel"
            title="Batalkan transaksi dan kembalikan uang"
          >
            âŒ Batalkan
          </button>
        </div>
      </div>

      <!-- Riwayat Pengembalian Uang -->
      <div *ngIf="refundHistory.length > 0" class="refund-history">
        <h4>ğŸ’¸ Riwayat Pengembalian Uang</h4>
        <div *ngFor="let refund of refundHistory" class="refund-item">
          <div class="refund-info">
            <strong>Refund ID: {{ refund.id }}</strong>
            <p>Transaksi ID: {{ refund.saleId }}</p>
            <p>Jumlah: Rp {{ refund.refundAmount.toLocaleString('id-ID') }}</p>
            <p>Alasan: {{ refund.reason }}</p>
            <small>{{ refund.refundDate | date : 'dd/MM/yyyy HH:mm' }}</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Pembatalan -->
  <div *ngIf="showCancelModal" class="modal-overlay">
    <div class="modal-content">
      <h3>ğŸ’° Konfirmasi Pembatalan & Pengembalian Uang</h3>

      <div *ngIf="selectedTransaction" class="cancel-details">
        <div class="detail-section">
          <h4>Detail Transaksi</h4>
          <p><strong>ID Transaksi:</strong> {{ selectedTransaction.id }}</p>
          <p>
            <strong>Tanggal:</strong> {{ selectedTransaction.date | date : 'dd/MM/yyyy HH:mm' }}
          </p>
          <p>
            <strong>Total Transaksi:</strong> Rp
            {{ selectedTransaction.total.toLocaleString('id-ID') }}
          </p>
          <p>
            <strong>Uang Diterima:</strong> Rp
            {{ selectedTransaction.cashReceived.toLocaleString('id-ID') }}
          </p>
        </div>

        <div class="refund-section">
          <h4>ğŸ’° Detail Pengembalian Uang</h4>
          <p>
            <strong>Uang yang akan dikembalikan:</strong> Rp
            {{ selectedTransaction.cashReceived.toLocaleString('id-ID') }}
          </p>
          <p><strong>Metode Pengembalian:</strong> Tunai</p>
          <p><strong>Status:</strong> Akan diproses</p>
        </div>

        <div class="cancel-items">
          <h4>ğŸ”„ Barang yang akan dikembalikan ke stok:</h4>
          <div *ngFor="let item of selectedTransaction.items" class="cancel-item">
            <span>{{ item.name }}</span>
            <span>{{ item.quantity }} x Rp {{ item.price.toLocaleString('id-ID') }}</span>
          </div>
        </div>

        <div class="warning-message">
          âš ï¸ <strong>Perhatian:</strong> Tindakan ini tidak dapat dibatalkan. Uang akan dikembalikan
          ke pelanggan dan stok barang akan ditambahkan kembali.
        </div>
      </div>

      <div class="modal-actions">
        <button (click)="closeCancelModal()" class="btn-secondary">Batal</button>
        <button (click)="cancelTransaction()" class="btn-danger">
          ğŸ’° Ya, Batalkan & Kembalikan Uang
        </button>
      </div>
    </div>
  </div>
</div>
